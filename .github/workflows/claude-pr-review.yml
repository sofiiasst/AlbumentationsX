name: Claude PR Review

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  pull_request:
    types: [opened, ready_for_review]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  # Automatic review on PR open/update
  auto-review:
    if: github.event_name == 'pull_request' && !github.event.pull_request.draft
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for better context

      - name: Claude PR Review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          direct_prompt: |
            Please perform a comprehensive code review of this pull request focusing on:

            ## Critical Analysis Areas:

            1. **Bug Detection**:
               - Logic errors and edge cases
               - Type safety issues (we use Python 3.10+ typing)
               - Potential runtime errors
               - Memory leaks or performance bottlenecks
               - Incorrect numpy/cv2 operations

            2. **Code Quality**:
               - Adherence to our coding standards (check CLAUDE.md)
               - Proper type hints using Python 3.10+ syntax (list not List, tuple not Tuple, | None not Optional)
               - Consistent parameter naming (_range suffix for intervals, no "Random" prefix for transforms)
               - No default values in InitSchema classes
               - Use of @uint8_io and @float32_io decorators where appropriate

            3. **Performance Optimizations**:
               - cv2.LUT opportunities for lookup-based operations (highest priority)
               - cv2 functions over numpy equivalents where faster
               - Vectorized numpy operations instead of loops
               - In-place operations to reduce memory allocations
               - Redundant computations that could be cached
               - Memory allocation patterns and unnecessary copies

            4. **AlbumentationsX Specific**:
               - Proper transform structure (apply, apply_to_mask, get_params_dependent_on_data)
               - Correct use of random generators (self.py_random, self.random_generator)
               - Proper parameter validation with InitSchema
               - Comprehensive docstring with Examples section
               - Support for arbitrary number of channels
               - Relative parameters instead of fixed pixel values

            5. **Testing**:
               - Missing test coverage
               - Edge cases not tested
               - Use of pytest.mark.parametrize for parameterized tests

            ## Review Format:

            Start with a brief summary, then provide specific feedback organized by severity:
            - ðŸ”´ **Critical**: Must fix before merge (bugs, security issues)
            - ðŸŸ¡ **Important**: Should fix (performance issues, code quality)
            - ðŸŸ¢ **Suggestion**: Nice to have (style improvements, minor optimizations)

            For each issue, provide:
            1. File and line number
            2. Current code snippet
            3. Suggested fix with code
            4. Explanation of why this matters

            If the code looks good, acknowledge what was done well.

  # Manual review trigger via @claude comment
  manual-review:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Manual Review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
